{% block doc -%}
<!DOCTYPE html>

{%- block html %}
<html lang="en">

<head>
  {%- block head %}

  {%- block metas %}
  <meta charset="UTF-8">

  {%- endblock metas %}
  <title>Flask Chat</title>

  {%- block styles %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">
  <link href="{{url_for('static',filename='css/bootstrap.min.css') }}" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/emojione/2.2.6/assets/css/emojione.min.css" />
  <link href="{{ url_for('static', filename='css/chat_style.css') }}" rel="stylesheet">
  {%- endblock styles %}


    <script src="//code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>    
    <!-- <script src="{{url_for('static',filename='js/socket.js')}}"></script> -->

    <script type="text/javascript" charset="utf-8">
        var socketio;
        $(document).ready(function(){
            // Use a "/test" namespace.
            // An application can open a connection on multiple namespaces, and
            // Socket.IO will multiplex all those connections on a single
            // physical channel. If you don't care about multiple channels, you
            // can set the namespace to an empty string.
            namespace = '';
            // socket_connection = 'http://' + document.domain + ':' + location.port+'/'+namespace;
            // socketio = io.connect(socket_connection);
            socketio = io.connect();

            socketio.on('connect', function() {
                    console.log('socket connected');
                    socketio.emit('connected')
            });

            // join a room
            $('#join').click(function(event){
              console.log("join event called")
              user_name = $("#current_user").text();
              console.log('Before emitting');
              user_name = user_name.substring(user_name.lastIndexOf("<")+1,user_name.lastIndexOf(">"));
              socketio.emit('joined',{user:user_name});
              console.log('After emitting');
              return false;
            });

            socketio.on("update_users",function(data){
              console.log('update_users called');
              console.log(data);
              usr = data['users'];
              var content = '';
              var i;
              
              for(i=0;i<usr.length;i++){
                // content += '<p>'+usr[i]+'</p>';
                content += "<div id='sidebar-user-box'><span class='collection-item' id='slider-username'>"+usr[i]+'</span></div><br>';
              }

              console.log('content = '+content);
              $('#origins-list').html(content);

            });

            socketio.on('join',function(){
              console.log('Caught join event');
            });

            $("#send").click(function(event){
              console.log('message button clicked')
              var msg = $("#message").val();
              $('#message').val('');
              console.log('msg = '+msg);
              user_name = $("#current_user").text();
              user_name = user_name.substring(user_name.lastIndexOf("<")+1,user_name.lastIndexOf(">")).substring(5,user_name.length);
              // $('#chat-messages').append("<p>"+user_name+":"+msg+"</p> \n");
              socketio.emit("add_message",{user:user_name,message:msg});
            });

            socketio.on('update_messages',function(data){
              console.log('update-messages invoked');
              console.log(data['messages']);
              msgs = data['messages'];
              var i;
              content = '';
              for(i=0;i<msgs.length;i++){
                content += "<p><b>"+msgs[i]['user']+"</b>:"+msgs[i]['message']+"</p><br>"
              }
              $('#chat-messages').html(content);
            });
        });
    </script>

  {%- endblock head %}
</head>

<body>
  <header>
    <nav class="navbar navbar-expand-sm navbar-dark" style="background-color: #274e68;">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('main.index') }}">Website</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#nav">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="nav">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item {% if request.path == url_for('main.index') %}active{% endif %}">
              <a class="nav-link" href="{{ url_for('main.index') }}">Home</a>
            </li>
          </ul>
          <ul class="navbar-nav ml-auto">
            {% if current_user.is_authenticated %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('main.logout') }}">Log Out</a>
            </li>
            {% else %}
            <li class="nav-item {% if request.path == url_for('main.login') %}active{% endif %}">
              <a class="nav-link" href="{{ url_for('main.login') }}">Login</a>
            </li>
            <li class="nav-item {% if request.path == url_for('main.register') %}active{% endif %}">
              <a class="nav-link" href="{{ url_for('main.register') }}">Register</a>
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

  </header>
  <main id="app">
    <div class="row">
          <div class="col s6">
            <div class="card horizontal">
              <div id="origins-list" class="card-content" v-html="chatContent">
                <!-- <div class="user_name"></div> -->
                <div id="origins-list" class="card-content">
                  
                  </div>
              </div>
            </div>
            
      <div>

      <div id="display_users"></div>

        <!-- {% block content %}
        <ul>
          {% for n in mylist %}
           <li>{{n}}</li>
          {% endfor %}
        </ul>
        
        {% endblock %} -->
          

          <div class="input-field col s8">
            <input type="text" v-model.trim="username" placeholder="Username">
          </div> 
          
        <div class="input-field col s2">
            <button class="waves-effect waves-light btn" id = "join">
              <i class="material-icons right">add_to_queue</i>
              Join
            </button>
          </div>
        </div>
      </div>
      <div class="col s6">
        <div class="card horizontal">
          <div id="chat-messages" class="card-content" v-html="chatContent">
          </div>
        </div>
      <div>
          <div class="input-field col s8">
            <input type="text" v-model="newMsg" placeholder="Type your message here..." id="message">
          </div>
          <div class="input-field col s4">
            <button class="waves-effect waves-light btn" id="send">
              <i class="material-icons right">send</i>
              Send
            </button>
          </div>
        </div>
      </div>

      <div class="input-field col s8" style = "display: none;"id="current_user">{{current_user}}</div>
  </main>
  <footer class="page-footer teal darken-3">
  </footer>


  <script type="text/x-template" id="modal-template">
      <transition name="modal">
        <div class="modal-mask">
          <div class="modal-wrapper">
            <div class="modal-container">
    
              <div class="modal-header">
                <slot name="header">
                  default header
                </slot>
              </div>
    
              <div class="modal-body">
                <slot name="body">
                  default body
                </slot>
              </div>
    
              <div class="modal-footer">
                <slot name="footer">
                  <button class="modal-default-button" @click="$emit('close')">
                    OK
                  </button>
                </slot>
              </div>
            </div>
          </div>
        </div>
      </transition>
    </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/md5.js"></script>
  <script src="https://cdn.jsdelivr.net/emojione/2.2.6/lib/js/emojione.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>
</body>
{%- endblock html %}
</html>
{% endblock doc -%}
